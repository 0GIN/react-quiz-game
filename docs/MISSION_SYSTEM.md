# üéØ System Misji - Dokumentacja Techniczna

## üìä Jak Dzia≈Ça Obecnie (TYLKO WY≈öWIETLANIE)

### Aktualna Implementacja

System misji **obecnie NIE DZIA≈ÅA automatycznie**. Jest to tylko **interfejs do wy≈õwietlania** danych z bazy.

#### Co Jest Zrobione ‚úÖ
1. **Baza danych** - Tabele `daily_missions` i `user_daily_missions`
2. **Wy≈õwietlanie** - Pobieranie i pokazywanie misji w Home.tsx
3. **Progress bar** - Wizualizacja postƒôpu (ale postƒôp trzeba ustawiƒá RƒòCZNIE w bazie)

#### Co NIE Jest Zrobione ‚ùå
1. **Automatyczne ≈õledzenie** - Gry nie aktualizujƒÖ postƒôpu misji
2. **Sprawdzanie warunk√≥w** - System nie wie, czy gracz wygra≈Ç 3 pojedynki
3. **Przyznawanie nagr√≥d** - FlashPoints i XP nie sƒÖ dodawane automatycznie
4. **Odblokowywanie misji** - Nowi u≈ºytkownicy nie dostajƒÖ automatycznie misji

---

## üîß Jak To POWINNO Dzia≈Çaƒá (Docelowo)

### Przep≈Çyw Danych

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Gracz Ko≈Ñczy Grƒô                                         ‚îÇ
‚îÇ    - Wygrana w Duel                                         ‚îÇ
‚îÇ    - Odpowied≈∫ na pytanie z geografii                      ‚îÇ
‚îÇ    - Bezb≈Çƒôdna gra                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Backend/Trigger Sprawdza Misje                          ‚îÇ
‚îÇ    SELECT * FROM user_daily_missions                        ‚îÇ
‚îÇ    WHERE user_id = ... AND is_completed = false             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Aktualizacja Postƒôpu                                     ‚îÇ
‚îÇ    UPDATE user_daily_missions                               ‚îÇ
‚îÇ    SET current_progress = current_progress + 1              ‚îÇ
‚îÇ    WHERE mission_type MATCHES current_action                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Sprawdzenie Uko≈Ñczenia                                   ‚îÇ
‚îÇ    IF current_progress >= target_value THEN                 ‚îÇ
‚îÇ      - SET is_completed = true                              ‚îÇ
‚îÇ      - SET completed_at = NOW()                             ‚îÇ
‚îÇ      - Przyznaj nagrody (FP + XP)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Frontend Od≈õwie≈ºa                                        ‚îÇ
‚îÇ    - Pokazuje ‚úì przy misji                                  ‚îÇ
‚îÇ    - Aktualizuje progress bar                               ‚îÇ
‚îÇ    - Wy≈õwietla powiadomienie "Misja uko≈Ñczona! +50 FP"     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üóÉÔ∏è Typy Misji (mission_type)

### Zdefiniowane w Bazie

| Typ | Opis | Jak Sprawdzaƒá |
|-----|------|---------------|
| `win_games` | Wygraj X gier | Po ka≈ºdej wygranej grze: `current_progress++` |
| `answer_category` | Odpowiedz na X pyta≈Ñ z kategorii | Po ka≈ºdym pytaniu z danej kategorii: `current_progress++` |
| `perfect_game` | Uko≈Ñcz X gier bezb≈Çƒôdnie | Po grze z 100% poprawno≈õciƒÖ: `current_progress++` |
| `play_games` | Zagraj X gier | Po ka≈ºdej sko≈Ñczonej grze: `current_progress++` |
| `earn_flash_points` | ZdobƒÖd≈∫ X FlashPoints | Po ka≈ºdej wygranej: `current_progress += earned_fp` |

---

## üíª Implementacja - 3 Podej≈õcia

### Podej≈õcie 1: PostgreSQL Triggers (Najlepsze dla Supabase)

**Zalety:** Automatyczne, nie wymaga logiki w frontendzie  
**Wady:** Wymaga SQL, trudniejsze w debugowaniu

```sql
-- Trigger po zako≈Ñczeniu gry
CREATE OR REPLACE FUNCTION check_missions_after_game()
RETURNS TRIGGER AS $$
BEGIN
    -- Aktualizuj misjƒô "Wygraj 3 gry" je≈õli gracz wygra≈Ç
    IF NEW.winner_id IS NOT NULL THEN
        UPDATE user_daily_missions
        SET current_progress = current_progress + 1
        WHERE user_id = NEW.winner_id
          AND mission_id IN (
              SELECT id FROM daily_missions 
              WHERE mission_type = 'win_games' 
              AND valid_date = CURRENT_DATE
          )
          AND is_completed = false;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER after_game_insert
AFTER INSERT ON games
FOR EACH ROW
EXECUTE FUNCTION check_missions_after_game();
```

### Podej≈õcie 2: Backend API (Zalecane dla Produkcji)

**Zalety:** Pe≈Çna kontrola, ≈Çatwe testowanie  
**Wady:** Wymaga w≈Çasnego backendu (Node.js, Python)

```typescript
// api/game/complete.ts
export async function completeGame(gameData: GameResult) {
  // 1. Zapisz wynik gry
  const game = await saveGameToDatabase(gameData);
  
  // 2. Sprawd≈∫ misje u≈ºytkownika
  await updateUserMissions(gameData.userId, {
    type: 'win_games',
    increment: gameData.isWinner ? 1 : 0
  });
  
  // 3. Sprawd≈∫ czy misja uko≈Ñczona
  await checkMissionCompletion(gameData.userId);
  
  return game;
}
```

### Podej≈õcie 3: Frontend (Tymczasowe, dla prototypu)

**Zalety:** Szybkie do zaimplementowania  
**Wady:** ≈Åatwe do zhackowania, nie persistent

```typescript
// src/services/missionService.ts
export async function updateMissionProgress(
  userId: string, 
  missionType: string, 
  increment: number = 1
) {
  // Pobierz aktywne misje u≈ºytkownika
  const { data: missions } = await supabase
    .from('user_daily_missions')
    .select('*, daily_missions(*)')
    .eq('user_id', userId)
    .eq('daily_missions.mission_type', missionType)
    .eq('is_completed', false);
  
  if (!missions || missions.length === 0) return;
  
  // Aktualizuj postƒôp
  for (const mission of missions) {
    const newProgress = mission.current_progress + increment;
    
    await supabase
      .from('user_daily_missions')
      .update({ current_progress: newProgress })
      .eq('id', mission.id);
    
    // Sprawd≈∫ uko≈Ñczenie
    if (newProgress >= mission.daily_missions.target_value) {
      await completeMission(mission.id, userId, mission.daily_missions);
    }
  }
}

async function completeMission(
  missionId: string, 
  userId: string, 
  missionData: DailyMission
) {
  // 1. Oznacz jako uko≈ÑczonƒÖ
  await supabase
    .from('user_daily_missions')
    .update({ 
      is_completed: true, 
      completed_at: new Date().toISOString() 
    })
    .eq('id', missionId);
  
  // 2. Przyznaj nagrody
  await supabase.rpc('add_mission_rewards', {
    p_user_id: userId,
    p_flash_points: missionData.flash_points_reward,
    p_experience: missionData.experience_reward
  });
  
  // 3. Poka≈º notyfikacjƒô
  showNotification(`Misja uko≈Ñczona! +${missionData.flash_points_reward} FP`);
}
```

---

## üõ†Ô∏è Funkcja PostgreSQL do Przyznawania Nagr√≥d

```sql
-- Funkcja RPC do dodawania nagr√≥d
CREATE OR REPLACE FUNCTION add_mission_rewards(
    p_user_id UUID,
    p_flash_points INTEGER,
    p_experience INTEGER
)
RETURNS void AS $$
BEGIN
    UPDATE users
    SET 
        flash_points = flash_points + p_flash_points,
        experience = experience + p_experience
    WHERE id = p_user_id;
END;
$$ LANGUAGE plpgsql;
```

---

## üöÄ Quick Start - Implementacja Podstawowa

### Krok 1: Utw√≥rz Serwis Misji

```typescript
// src/services/missionService.ts
import { supabase } from '../lib/supabase';

export interface MissionProgress {
  missionType: string;
  increment?: number;
  categoryId?: number; // dla answer_category
}

export async function trackMissionProgress(
  userId: string,
  progress: MissionProgress
) {
  try {
    // Pobierz misje tego typu
    const { data: userMissions, error } = await supabase
      .from('user_daily_missions')
      .select(`
        id,
        current_progress,
        is_completed,
        daily_missions (
          id,
          mission_type,
          target_value,
          flash_points_reward,
          experience_reward
        )
      `)
      .eq('user_id', userId)
      .eq('is_completed', false)
      .eq('daily_missions.mission_type', progress.missionType)
      .eq('daily_missions.valid_date', new Date().toISOString().split('T')[0]);

    if (error || !userMissions) return;

    // Aktualizuj postƒôp dla ka≈ºdej pasujƒÖcej misji
    for (const mission of userMissions) {
      const newProgress = mission.current_progress + (progress.increment || 1);
      
      // Update progress
      await supabase
        .from('user_daily_missions')
        .update({ current_progress: newProgress })
        .eq('id', mission.id);

      // Check completion
      if (newProgress >= mission.daily_missions.target_value) {
        await completeMission(mission.id, userId, mission.daily_missions);
      }
    }
  } catch (err) {
    console.error('Mission tracking error:', err);
  }
}

async function completeMission(missionId: string, userId: string, mission: any) {
  // Mark as completed
  await supabase
    .from('user_daily_missions')
    .update({ 
      is_completed: true, 
      completed_at: new Date().toISOString() 
    })
    .eq('id', missionId);

  // Award rewards (you need to implement this)
  // await giveRewards(userId, mission.flash_points_reward, mission.experience_reward);
}
```

### Krok 2: U≈ºyj w Grze

```typescript
// Po zako≈Ñczeniu gry
async function handleGameEnd(gameResult: GameResult) {
  const userId = user.id;
  
  // ≈öled≈∫ postƒôp misji
  await trackMissionProgress(userId, { missionType: 'play_games' });
  
  if (gameResult.isWinner) {
    await trackMissionProgress(userId, { missionType: 'win_games' });
  }
  
  if (gameResult.accuracy === 100) {
    await trackMissionProgress(userId, { missionType: 'perfect_game' });
  }
  
  // Od≈õwie≈º UI
  refreshMissions();
}
```

---

## üìã Checklist Implementacji

### Minimum Viable Product (MVP)
- [ ] Utworzyƒá `src/services/missionService.ts`
- [ ] Funkcja `trackMissionProgress()`
- [ ] Funkcja `completeMission()`
- [ ] Wywo≈Çania w miejscach akcji (po grze, po pytaniu)
- [ ] Od≈õwie≈ºanie UI po update

### Funkcje Dodatkowe
- [ ] Powiadomienia o uko≈Ñczeniu misji
- [ ] Animacje progress bara
- [ ] Auto-odblokowywanie misji dla nowych u≈ºytkownik√≥w
- [ ] PostgreSQL triggers (zaawansowane)
- [ ] Real-time updates (Supabase Realtime)

### Testy
- [ ] Test: Wygrana aktualizuje "win_games"
- [ ] Test: Bezb≈Çƒôdna gra aktualizuje "perfect_game"
- [ ] Test: Nagrody sƒÖ przyznawane
- [ ] Test: Misja oznaczona jako uko≈Ñczona

---

## ‚ö†Ô∏è Obecny Stan

**Status:** üü° CZƒò≈öCIOWO DZIA≈ÅAJƒÑCY

- ‚úÖ Struktura bazy danych
- ‚úÖ Wy≈õwietlanie misji
- ‚úÖ Progress bar
- ‚ùå Automatyczne ≈õledzenie
- ‚ùå Sprawdzanie warunk√≥w
- ‚ùå Przyznawanie nagr√≥d
- ‚ùå Powiadomienia

**Aby system dzia≈Ça≈Ç w 100%, trzeba:**
1. Stworzyƒá `missionService.ts`
2. Dodaƒá wywo≈Çania po akcjach gracza
3. Zaimplementowaƒá przyznawanie nagr√≥d

---

**Data utworzenia:** 2025-10-24  
**Autor:** System Dokumentacji
